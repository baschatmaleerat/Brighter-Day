<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smoke Logger</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            /* Inter font */
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar for log history */
        #log-history-list::-webkit-scrollbar {
            width: 4px;
        }
        #log-history-list::-webkit-scrollbar-thumb {
            background-color: #6C757D; /* text-muted */
            border-radius: 20px;
        }

        /* Overlay for side drawer */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40; /* Below drawer, above content */
            transition: opacity 0.3s ease;
        }

        /* Side drawer */
        .drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background: var(--tw-colors-bg-dark); /* Using bg-dark */
            color: var(--tw-colors-text-light);
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }

        .drawer.open {
            transform: translateX(0);
        }
    </style>
    <script>
        // Tailwind configuration with the NEW dark theme
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'bg-dark': '#1D2B44',       // Dark Navy/Black
                        'bg-content': '#2a3b5a',   // Slightly lighter navy for cards
                        'primary-blue': '#3772FF',   // Bright Blue
                        'light-blue': '#4D94FF',   // Lighter Blue
                        'accent-yellow': '#FFC42D', // Gold/Yellow
                        'text-light': '#F8F9FA',     // Off-white text
                        'text-muted': '#9CA3AF',     // gray-400 for muted text
                        'border-dark': '#4a5c7a',   // Border color for cards
                        'success-green': '#10B981', // emerald-500
                        'danger-red': '#EF4444', // red-500
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-bg-dark text-text-light antialiased">

    <!-- Drawer Overlay -->
    <div id="drawer-overlay" class="overlay hidden opacity-0"></div>

    <!-- Drawer Navigation Menu -->
    <aside id="drawer" class="drawer">
        <div class="p-4 flex items-center justify-between bg-primary-blue">
            <h2 class="text-xl font-bold text-white">Menu</h2>
            <button id="close-drawer-btn" class="text-white hover:text-white/80 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <nav class="flex-1 py-4">
            <button id="drawer-nav-log" class="w-full text-left p-4 text-lg font-semibold text-text-light hover:bg-bg-content focus:outline-none transition-colors duration-200">
                Log Activity
            </button>
            <button id="drawer-nav-settings" class="w-full text-left p-4 text-lg font-semibold text-text-light hover:bg-bg-content focus:outline-none transition-colors duration-200">
                Settings
            </button>
        </nav>
        <div class="p-4 text-center text-xs text-text-muted mt-auto">
            <span class="block">Your User ID:</span>
            <p id="user-id-display" class="break-all"></p>
        </div>
    </aside>

    <!-- Main App Container -->
    <div id="app-container" class="max-w-md mx-auto min-h-screen bg-bg-dark shadow-xl overflow-hidden">
        
        <!-- Header -->
        <header class="bg-primary-blue text-white p-4 shadow-md flex items-center">
            <button id="open-drawer-btn" class="mr-3 text-white hover:text-white/80 focus:outline-none">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 class="text-2xl font-bold text-center flex-grow">Smoke Logger</h1>
        </header>

        <!-- Loading Indicator -->
        <div id="loading" class="p-6 text-center">
            <p class="text-text-muted">Loading...</p>
        </div>

        <!-- Main Content (Log & Settings) -->
        <main id="main-content" class="hidden">

            <!-- Log View -->
            <section id="log-view" class="p-4">
                
                <!-- Log Type Selection -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button id="select-weed-btn" class="p-4 rounded-xl shadow-md font-bold text-white bg-primary-blue hover:bg-light-blue transition-colors duration-200 text-lg">
                        Log Weed
                    </button>
                    <button id="select-nicotine-btn" class="p-4 rounded-xl shadow-md font-bold text-white bg-light-blue hover:bg-primary-blue transition-colors duration-200 text-lg">
                        Log Nicotine
                    </button>
                </div>

                <!-- Log Form Container -->
                <div id="log-form-container" class="mb-6">
                    <!-- Dynamic content inserted here by JS -->
                </div>

                <!-- Log History -->
                <div id="log-history">
                    <h2 class="text-xl font-bold text-text-light mb-3">Recent Activity</h2>
                    <div id="log-history-list" class="max-h-64 overflow-y-auto bg-bg-content p-3 rounded-lg border border-border-dark shadow-inner">
                        <p id="log-empty-state" class="text-text-muted text-center py-4">No logs yet.</p>
                        <!-- Dynamic content inserted here by JS -->
                    </div>
                </div>
            </section>

            <!-- Settings View -->
            <section id="settings-view" class="hidden p-4">
                <div class="space-y-6">
                    
                    <!-- General Settings Card -->
                    <div class="p-5 bg-bg-content border border-border-dark rounded-xl shadow-sm">
                        <h3 class="text-xl font-bold text-text-light mb-3">General Settings</h3>
                        <div class="space-y-3">
                            <div class="flex items-center space-x-3">
                                <label for="currency-input" class="font-semibold text-text-muted min-w-[70px]">Currency:</label>
                                <input type="text" id="currency-input" class="flex-1 p-2 bg-bg-dark border border-border-dark text-text-light rounded-md focus:ring-2 focus:ring-accent-yellow focus:border-accent-yellow transition-all duration-150">
                            </div>
                            <div class="flex items-center space-x-3">
                                <label for="metric-input" class="font-semibold text-text-muted min-w-[70px]">Metric:</label>
                                <input type="text" id="metric-input" class="flex-1 p-2 bg-bg-dark border border-border-dark text-text-light rounded-md focus:ring-2 focus:ring-accent-yellow focus:border-accent-yellow transition-all duration-150">
                            </div>
                        </div>
                    </div>

                    <!-- Weed Options Card -->
                    <div class="p-5 bg-bg-content border border-border-dark rounded-xl shadow-sm">
                        <h3 class="text-xl font-bold text-text-light mb-3">Weed Options</h3>
                        <div id="weed-options-container" class="space-y-3 mb-4">
                            <!-- Dynamic content inserted here by JS -->
                        </div>
                        <div class="flex space-x-3">
                            <input type="text" id="new-weed-option" class="flex-1 p-2 bg-bg-dark border border-border-dark text-text-light rounded-md focus:ring-2 focus:ring-accent-yellow focus:border-accent-yellow transition-all duration-150" placeholder="New option name">
                            <button id="add-weed-btn" class="px-5 py-2 bg-primary-blue text-white rounded-md font-semibold hover:bg-light-blue transition-colors duration-200">Add</button>
                        </div>
                    </div>

                    <!-- Nicotine Options Card -->
                    <div class="p-5 bg-bg-content border border-border-dark rounded-xl shadow-sm">
                        <h3 class="text-xl font-bold text-text-light mb-3">Nicotine Options</h3>
                        <div id="nicotine-options-container" class="space-y-3 mb-4">
                            <!-- Dynamic content inserted here by JS -->
                        </div>
                        <div class="flex space-x-3">
                            <input type="text" id="new-nicotine-option" class="flex-1 p-2 bg-bg-dark border border-border-dark text-text-light rounded-md focus:ring-2 focus:ring-accent-yellow focus:border-accent-yellow transition-all duration-150" placeholder="New option name">
                            <button id="add-nicotine-btn" class="px-5 py-2 bg-light-blue text-white rounded-md font-semibold hover:bg-primary-blue transition-colors duration-200">Add</button>
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <button id="save-settings-btn" class="w-full p-4 bg-accent-yellow text-bg-dark rounded-xl font-bold text-lg shadow-md hover:bg-opacity-90 transition-colors duration-200">
                        Save Settings
                    </button>
                    
                    <!-- Settings Save Message -->
                    <p id="settings-message" class="text-center font-medium h-5"></p>
                </div>
            </section>

        </main>
    </div>

    <!-- Firebase & App Logic Script -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot, 
            collection, 
            addDoc, 
            query, 
            serverTimestamp,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config and App State ---

        // App ID and Firebase Config from environment (provided by Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-smoke-logger';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, userId;
        
        // Global App State
        let currentView = 'log'; // 'log' or 'settings'
        let currentLogType = null; // 'weed' or 'nicotine'
        let appSettings = {}; // To hold loaded settings
        let appLogs = []; // To hold loaded logs
        let settingsUnsubscribe = () => {}; // To detach Firestore listener
        let logsUnsubscribe = () => {}; // To detach Firestore listener

        // --- DOM Elements ---
        const loadingEl = document.getElementById('loading');
        const mainContentEl = document.getElementById('main-content');
        
        // Drawer elements
        const openDrawerBtn = document.getElementById('open-drawer-btn');
        const closeDrawerBtn = document.getElementById('close-drawer-btn');
        const drawer = document.getElementById('drawer');
        const drawerOverlay = document.getElementById('drawer-overlay');
        const drawerNavLogBtn = document.getElementById('drawer-nav-log');
        const drawerNavSettingsBtn = document.getElementById('drawer-nav-settings');

        const logView = document.getElementById('log-view');
        const settingsView = document.getElementById('settings-view');
        const selectWeedBtn = document.getElementById('select-weed-btn');
        const selectNicotineBtn = document.getElementById('select-nicotine-btn');
        const logFormContainer = document.getElementById('log-form-container');
        const logHistoryList = document.getElementById('log-history-list');
        const logEmptyState = document.getElementById('log-empty-state');
        const currencyInput = document.getElementById('currency-input');
        const metricInput = document.getElementById('metric-input');
        const weedOptionsContainer = document.getElementById('weed-options-container');
        const newWeedOptionInput = document.getElementById('new-weed-option');
        const addWeedBtn = document.getElementById('add-weed-btn');
        const nicotineOptionsContainer = document.getElementById('nicotine-options-container');
        const newNicotineOptionInput = document.getElementById('new-nicotine-option');
        const addNicotineBtn = document.getElementById('add-nicotine-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const settingsMessage = document.getElementById('settings-message');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- Default Settings ---
        const DEFAULT_SETTINGS = {
            currency: "USD",
            metric: "g",
            weedOptions: ["joint", "vape"],
            nicotineOptions: ["rollies"],
            costs: {
                "joint": 10,
                "vape": 5,
                "rollies": 1
            },
            amounts: {
                "joint": 0.5,
                "vape": 0.2,
                "rollies": 0.1
            }
        };

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        // User is authenticated, load their data
                        await setupFirestoreListeners();
                        mainContentEl.classList.remove('hidden');
                        loadingEl.classList.add('hidden');
                        render(); // Initial render
                    } else {
                        // No user, sign in
                        await signIn();
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                loadingEl.textContent = "Error loading app. Please refresh.";
            }
        }

        async function signIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Sign-In Error:", error);
                loadingEl.textContent = "Error signing in.";
            }
        }
        
        // --- Firestore Data Handling ---
        async function setupFirestoreListeners() {
            if (!userId) return;

            // Detach previous listeners if they exist
            settingsUnsubscribe();
            logsUnsubscribe();

            // 1. Settings Listener
            const settingsRef = doc(db, `artifacts/${appId}/users/${userId}/settings/config`);
            settingsUnsubscribe = onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    appSettings = docSnap.data();
                } else {
                    // No settings found, create default
                    appSettings = DEFAULT_SETTINGS;
                    setDoc(settingsRef, appSettings).catch(e => console.error("Error setting default settings:", e));
                }
                render(); // Re-render with new settings
            }, (error) => {
                console.error("Settings listener error:", error);
            });

            // 2. Logs Listener
            const logsRef = collection(db, `artifacts/${appId}/users/${userId}/logs`);
            // We sort manually after fetching to avoid Firestore index errors.
            const q = query(logsRef); 
            logsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                appLogs = [];
                querySnapshot.forEach((doc) => {
                    appLogs.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort logs in memory (newest first)
                appLogs.sort((a, b) => {
                    const timeA = a.timestamp?.seconds || 0;
                    const timeB = b.timestamp?.seconds || 0;
                    return timeB - timeA;
                });
                
                renderLogHistory(); // Just re-render the log history
            }, (error) => {
                console.error("Logs listener error:", error);
            });
        }

        // Save settings to Firestore
        async function handleSaveSettings() {
            if (!userId) return;
            
            settingsMessage.textContent = "Saving...";
            settingsMessage.classList.remove('text-danger-red', 'text-success-green');
            settingsMessage.classList.add('text-text-muted');
            
            try {
                const settingsRef = doc(db, `artifacts/${appId}/users/${userId}/settings/config`);
                
                // Create new settings object from DOM
                const newSettings = {
                    currency: currencyInput.value || 'USD',
                    metric: metricInput.value || 'g',
                    weedOptions: [],
                    nicotineOptions: [],
                    costs: {},
                    amounts: {}
                };

                // Parse weed options
                document.querySelectorAll('#weed-options-container .option-item').forEach(item => {
                    const name = item.dataset.optionName;
                    const cost = parseFloat(item.querySelector('.cost-input').value) || 0;
                    const amount = parseFloat(item.querySelector('.amount-input').value) || 0;
                    
                    newSettings.weedOptions.push(name);
                    newSettings.costs[name] = cost;
                    newSettings.amounts[name] = amount;
                });
                
                // Parse nicotine options
                document.querySelectorAll('#nicotine-options-container .option-item').forEach(item => {
                    const name = item.dataset.optionName;
                    const cost = parseFloat(item.querySelector('.cost-input').value) || 0;
                    const amount = parseFloat(item.querySelector('.amount-input').value) || 0;
                    
                    newSettings.nicotineOptions.push(name);
                    newSettings.costs[name] = cost;
                    newSettings.amounts[name] = amount;
                });

                await setDoc(settingsRef, newSettings); // Overwrite with new settings
                appSettings = newSettings; // Update local state
                
                settingsMessage.textContent = "Settings saved!";
                settingsMessage.classList.remove('text-text-muted');
                settingsMessage.classList.add('text-success-green');
                setTimeout(() => { settingsMessage.textContent = ""; }, 2000);

            } catch (error) {
                console.error("Error saving settings:", error);
                settingsMessage.textContent = "Error saving.";
                settingsMessage.classList.remove('text-text-muted');
                settingsMessage.classList.add('text-danger-red');
            }
        }
        
        // Add a new log entry
        async function handleAddLog(type, item, quantity) {
            if (!userId || !quantity || quantity <= 0) return;

            try {
                const logsRef = collection(db, `artifacts/${appId}/users/${userId}/logs`);
                const costPerUnit = appSettings.costs?.[item] || 0;
                const amountPerUnit = appSettings.amounts?.[item] || 0;

                const newLog = {
                    type: type,
                    item: item,
                    quantity: quantity,
                    cost: costPerUnit * quantity,
                    amount: amountPerUnit * quantity,
                    metric: appSettings.metric || 'g',
                    currency: appSettings.currency || 'USD',
                    timestamp: serverTimestamp()
                };

                await addDoc(logsRef, newLog);
                
                // Reset log form
                currentLogType = null;
                renderLogForm();

            } catch (error) {
                console.error("Error adding log:", error);
            }
        }

        // --- Render Functions ---
        
        // Main render function
        function render() {
            if (currentView === 'log') {
                logView.classList.remove('hidden');
                settingsView.classList.add('hidden');
                // Update drawer nav active state
                drawerNavLogBtn.classList.add('bg-primary-blue');
                drawerNavLogBtn.classList.remove('hover:bg-bg-content');
                drawerNavSettingsBtn.classList.remove('bg-primary-blue');
                drawerNavSettingsBtn.classList.add('hover:bg-bg-content');
                
                renderLogForm();
                renderLogHistory();
            } else {
                logView.classList.add('hidden');
                settingsView.classList.remove('hidden');
                // Update drawer nav active state
                drawerNavSettingsBtn.classList.add('bg-primary-blue');
                drawerNavSettingsBtn.classList.remove('hover:bg-bg-content');
                drawerNavLogBtn.classList.remove('bg-primary-blue');
                drawerNavLogBtn.classList.add('hover:bg-bg-content');
                
                renderSettings();
            }
        }

        // Render the dynamic logging form
        function renderLogForm() {
            if (!currentLogType) {
                logFormContainer.innerHTML = '<p class="text-center text-text-muted text-lg italic p-4">Select an option above to log.</p>';
                selectWeedBtn.classList.remove("ring-4", "ring-primary-blue/50");
                selectNicotineBtn.classList.remove("ring-4", "ring-light-blue/50");
                return;
            }

            let options = [];
            let bgColor = 'bg-primary-blue';
            
            if (currentLogType === 'weed') {
                options = appSettings.weedOptions || [];
                bgColor = 'bg-primary-blue';
                selectWeedBtn.classList.add("ring-4", "ring-primary-blue/50");
                selectNicotineBtn.classList.remove("ring-4", "ring-light-blue/50");
            } else if (currentLogType === 'nicotine') {
                options = appSettings.nicotineOptions || [];
                bgColor = 'bg-light-blue';
                selectWeedBtn.classList.remove("ring-4", "ring-primary-blue/50");
                selectNicotineBtn.classList.add("ring-4", "ring-light-blue/50");
            }

            if (options.length === 0) {
                logFormContainer.innerHTML = `<p class="text-center text-text-muted p-4 bg-bg-content rounded-lg border border-border-dark shadow-inner">No options defined for ${currentLogType}. Go to Settings to add some.</p>`;
                return;
            }

            logFormContainer.innerHTML = options.map(option => `
                <div class="flex items-center space-x-3 mb-3 p-3 bg-bg-content rounded-lg border border-border-dark shadow-sm">
                    <input type="number" id="input-${option}" min="1" class="w-20 p-2 bg-bg-dark border border-border-dark text-text-light rounded-md text-lg focus:ring-2 focus:ring-accent-yellow focus:border-accent-yellow transition-all duration-150" placeholder="Qty">
                    <button data-type="${currentLogType}" data-item="${option}" 
                            class="log-item-btn flex-1 p-3 ${bgColor} text-white rounded-md font-bold capitalize hover:opacity-90 transition-opacity duration-200 text-lg">
                        Log ${option}
                    </button>
                </div>
            `).join('');
        }

        // Render the list of log entries
        function renderLogHistory() {
            if (appLogs.length === 0) {
                logEmptyState.classList.remove('hidden');
                logHistoryList.innerHTML = '';
                logHistoryList.appendChild(logEmptyState);
                return;
            }

            logEmptyState.classList.add('hidden');
            logHistoryList.innerHTML = appLogs.map(log => {
                const date = log.timestamp ? log.timestamp.toDate().toLocaleString() : 'Just now';
                const bgColor = 'bg-bg-content';
                const borderColor = log.type === 'weed' ? 'border-primary-blue' : 'border-light-blue';
                
                return `
                    <div class="p-3 ${bgColor} border-l-4 ${borderColor} rounded-r-md mb-2 shadow-sm">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-text-light text-lg capitalize">${log.quantity} ${log.item}</span>
                            <span class="font-bold text-text-light text-lg">${(appSettings.currency || '')}${Number(log.cost).toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm text-text-muted">
                            <span>${date}</span>
                            <span>${Number(log.amount).toFixed(2)} ${appSettings.metric || ''}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render the settings page inputs
        function renderSettings() {
            currencyInput.value = appSettings.currency || '';
            metricInput.value = appSettings.metric || '';
            
            // Render weed options
            weedOptionsContainer.innerHTML = (appSettings.weedOptions || []).map(option => 
                renderSettingsOption(option)
            ).join('');

            // Render nicotine options
            nicotineOptionsContainer.innerHTML = (appSettings.nicotineOptions || []).map(option => 
                renderSettingsOption(option)
            ).join('');
        }
        
        // This function properly stacks inputs to prevent overflow
        function renderSettingsOption(optionName) {
            const cost = appSettings.costs?.[optionName] || 0;
            const amount = appSettings.amounts?.[optionName] || 0;
            const currency = appSettings.currency || '';
            const metric = appSettings.metric || 'g';
            
            return `
                <div class="option-item p-3 border border-border-dark rounded-lg space-y-3 bg-bg-dark" data-option-name="${optionName}">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-text-light capitalize text-lg">${optionName}</span>
                        <button class="remove-option-btn text-danger-red hover:text-danger-red/80 font-medium transition-colors duration-200" data-name="${optionName}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <label class="text-sm font-medium text-text-muted">Cost (in ${currency})</label>
                            <input type="number" class="cost-input w-full p-2 bg-bg-content border border-border-dark text-text-light rounded-md focus:ring-2 focus:ring-accent-yellow focus:border-accent-yellow transition-all duration-150" value="${cost}" placeholder="Cost per item">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-text-muted">Amount (in ${metric})</LabeL>
                            <input type="number" class="amount-input w-full p-2 bg-bg-content border border-border-dark text-text-light rounded-md focus:ring-2 focus:ring-accent-yellow focus:border-accent-yellow transition-all duration-150" value="${amount}" placeholder="Amount per item">
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- Drawer Functions ---
        function openDrawer() {
            drawer.classList.add('open');
            drawerOverlay.classList.remove('hidden');
            setTimeout(() => drawerOverlay.classList.add('opacity-100'), 10);
        }

        function closeDrawer() {
            drawer.classList.remove('open');
            drawerOverlay.classList.remove('opacity-100');
            setTimeout(() => drawerOverlay.classList.add('hidden'), 300); // Hide after transition
        }


        // --- Event Listeners ---
        
        // Drawer Navigation
        openDrawerBtn.addEventListener('click', openDrawer);
        closeDrawerBtn.addEventListener('click', closeDrawer);
        drawerOverlay.addEventListener('click', closeDrawer);

        // *** BUG FIX WAS HERE ***
        drawerNavLogBtn.addEventListener('click', () => {
            currentView = 'log';
            render();
            closeDrawer();
        });
        drawerNavSettingsBtn.addEventListener('click', () => {
            currentView = 'settings';
            render();
            closeDrawer();
        });

        // Log View
        selectWeedBtn.addEventListener('click', () => {
            currentLogType = 'weed';
            renderLogForm();
        });
        selectNicotineBtn.addEventListener('click', () => {
            currentLogType = 'nicotine';
            renderLogForm();
        });
        
        // Event delegation for logging buttons
        logFormContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('log-item-btn')) {
                const item = e.target.dataset.item;
                const type = e.target.dataset.type;
                const input = document.getElementById(`input-${item}`);
                const quantity = parseInt(input.value);
                
                if (quantity > 0) {
                    handleAddLog(type, item, quantity);
                    input.value = ''; // Clear input
                } else {
                    // Show a simple validation
                    input.classList.add('border-danger-red', 'ring-2', 'ring-danger-red/50');
                    setTimeout(() => {
                        input.classList.remove('border-danger-red', 'ring-2', 'ring-danger-red/50');
                    }, 1500);
                }
            }
        });

        // Settings View
        saveSettingsBtn.addEventListener('click', handleSaveSettings);

        addWeedBtn.addEventListener('click', () => {
            const newOptionName = newWeedOptionInput.value.trim().toLowerCase();
            if (newOptionName && !(appSettings.weedOptions || []).includes(newOptionName)) {
                // Add to local state and re-render settings
                if (!appSettings.weedOptions) appSettings.weedOptions = [];
                appSettings.weedOptions.push(newOptionName);
                if (!appSettings.costs) appSettings.costs = {};
                appSettings.costs[newOptionName] = 0;
                if (!appSettings.amounts) appSettings.amounts = {};
                appSettings.amounts[newOptionName] = 0;
                
                renderSettings();
                newWeedOptionInput.value = '';
            }
        });

        addNicotineBtn.addEventListener('click', () => {
            const newOptionName = newNicotineOptionInput.value.trim().toLowerCase();
            if (newOptionName && !(appSettings.nicotineOptions || []).includes(newOptionName)) {
                if (!appSettings.nicotineOptions) appSettings.nicotineOptions = [];
                appSettings.nicotineOptions.push(newOptionName);
                if (!appSettings.costs) appSettings.costs = {};
                appSettings.costs[newOptionName] = 0;
                if (!appSettings.amounts) appSettings.amounts = {};
                appSettings.amounts[newOptionName] = 0;
                
                renderSettings();
                newNicotineOptionInput.value = '';
            }
        });
        
        // Helper function to find parent container
        const findParentContainer = (el) => {
            if (el.id === 'weed-options-container') return 'weed';
            if (el.id === 'nicotine-options-container') return 'nicotine';
            if (el.parentElement) return findParentContainer(el.parentElement);
            return null;
        }

        // Event delegation for remove buttons (Updated)
        document.getElementById('settings-view').addEventListener('click', (e) => {
            const btn = e.target.closest('.remove-option-btn');
            if (btn) {
                const name = btn.dataset.name;
                const type = findParentContainer(btn); // Find which list it's in

                if (type === 'weed') {
                    appSettings.weedOptions = appSettings.weedOptions.filter(opt => opt !== name);
                    delete appSettings.costs[name];
                    delete appSettings.amounts[name];
                } else if (type === 'nicotine') {
                    appSettings.nicotineOptions = appSettings.nicotineOptions.filter(opt => opt !== name);
                    delete appSettings.costs[name];
                    delete appSettings.amounts[name];
                }
                
                renderSettings(); // Re-render settings to remove the item
            }
        });

        // --- Start App ---
        initializeFirebase();

    </script>
</body>
</html>

